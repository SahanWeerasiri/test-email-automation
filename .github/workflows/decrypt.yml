name: Issue-Based PGP Decryption

on:
  issues:
    types: [opened]

jobs:
  decrypt:
    # Only run if the issue title starts with "DECRYPT"
    if: startsWith(github.event.issue.title, 'DECRYPT')

    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write # Needed for commenting and closing the issue

    steps:
      - name: üîç Extract Encrypted Content from Issue Body
        id: parse_issue
        run: |
          # Use awk to find and extract the full PGP MESSAGE block
          ENCRYPTED_DATA=$(echo "${{ github.event.issue.body }}" | awk '/-----BEGIN PGP MESSAGE-----/,/-----END PGP MESSAGE-----/')
          
          if [ -z "$ENCRYPTED_DATA" ]; then
            echo "::error::Could not find PGP MESSAGE block in the issue body."
            echo "ENCRYPTED_CONTENT_FOUND=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "ENCRYPTED_CONTENT_FOUND=true" >> $GITHUB_OUTPUT
          # Save the data to a temporary file for the gpg command
          echo "$ENCRYPTED_DATA" > encrypted.pgp
        
      - name: üîê Setup GnuPG, Import Key, and Set Trust (FIXED TTY Error)
        if: success() && steps.parse_issue.outputs.ENCRYPTED_CONTENT_FOUND == 'true'
        run: |
          # 1. Create a temporary, isolated GPG home directory
          export GNUPGHOME=$(mktemp -d)
          echo "GPG Home set to: $GNUPGHOME"
          
          # --- IMPORTANT: REPLACE WITH YOUR KEY'S EMAIL/UID ---
          KEY_ID="smudunlahiru@gmail.com"
          # ---------------------------------------------------

          # 2. Import the Private Key from GitHub Secrets
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          
          # 3. FIX: Set the key to ultimate trust non-interactively
          KEY_FINGERPRINT=$(gpg --list-secret-keys --with-colons | grep -B 1 "$KEY_ID" | head -n 1 | awk -F: '{print $5}')
          
          if [ -n "$KEY_FINGERPRINT" ]; then
            echo "Setting ultimate trust (level 6) for fingerprint: $KEY_FINGERPRINT"
            # Use import-ownertrust to set the trust level without needing a TTY
            echo "$KEY_FINGERPRINT:6:" | gpg --import-ownertrust
            echo "Key trust successfully updated."
          else
            echo "Warning: Could not find key fingerprint for $KEY_ID. Check KEY_ID variable."
          fi
          
          echo "GNUPGHOME=$GNUPGHOME" >> $GITHUB_ENV # Store GPG home for cleanup
          
      - name: üîë Decrypt Content (FINAL FIX)
        id: decrypt_step
        if: success()
        env:
          PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          
        run: |
          # 1. Write the passphrase to a temporary file for reliable passing via FD
          echo "${{ env.PASSPHRASE }}" > passphrase.txt
          chmod 600 passphrase.txt

          # Use file descriptor 3 to pass the passphrase from the file
          DECRYPTED_RESULT=$(gpg --batch --passphrase-fd 3 --output - --decrypt encrypted.pgp 3<passphrase.txt 2>&1)
          
          # 3. Clean up the passphrase file immediately
          rm passphrase.txt

          # Check for decryption failure message
          if echo "$DECRYPTED_RESULT" | grep -q "gpg: decryption failed:"; then
            echo "DECRYPTED_CONTENT=Decryption failed. Please verify the key and passphrase used for encryption." >> $GITHUB_OUTPUT
            echo "DECRYPT_STATUS=failed" >> $GITHUB_OUTPUT
          else
            echo "Decryption succeeded."
            # Set the decrypted content as a multi-line output
            echo "DECRYPTED_CONTENT<<EOF" >> $GITHUB_OUTPUT
            echo "$DECRYPTED_RESULT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "DECRYPT_STATUS=success" >> $GITHUB_OUTPUT
          fi
          
      - name: üí¨ Comment Decryption Result
        uses: peter-evans/create-or-update-comment@v3 # Used ONLY for commenting
        if: always()
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## üîì PGP Decryption Status: ${{ steps.decrypt_step.outputs.DECRYPT_STATUS }}
            
            ${{ steps.decrypt_step.outputs.DECRYPT_STATUS == 'success' && '### Decrypted Content' || ''}}
            
            ```plaintext
            ${{ steps.decrypt_step.outputs.DECRYPTED_CONTENT }}
            ```
            
            ---
            *Note: This message was automatically generated by the Decryption GitHub Action.*

      - name: ‚ùå Close Issue on Successful Decryption (FIXED issue-state Warning)
        uses: peter-evans/close-issue@v3 # Used dedicated action to close the issue
        # Only run if the decryption step was successful
        if: success() && steps.decrypt_step.outputs.DECRYPT_STATUS == 'success'
        with:
          issue-number: ${{ github.event.issue.number }}
          comment: "Decryption successfully completed. Closing this issue."
          
      - name: üóëÔ∏è Cleanup
        # Remove the temporary GPG home directory immediately
        if: always()
        run: rm -rf "${{ env.GNUPGHOME }}"
        env:
          GNUPGHOME: ${{ env.GNUPGHOME }}
