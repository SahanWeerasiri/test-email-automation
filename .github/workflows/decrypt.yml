name: 'GPG Issue Decryptor'

on:
  # Trigger when a new issue is opened or edited
  issues:
    types: [opened, edited]

jobs:
  decrypt_and_comment:
    runs-on: ubuntu-latest
    
    # Permissions are crucial for reading issue body and writing comments/closing
    permissions:
      issues: write # Allows reading the issue and creating comments/closing

    env:
      # These environment variables use the secret values defined in your GitHub settings
      GPG_KEY_ID: 'test-server@example.com'
      GPG_PRIVATE_KEY_SECRET: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE_SECRET: ${{ secrets.GPG_PASSPHRASE }}

    steps:
      - name: Check for Trigger Keyword and Extract Encrypted Text
        id: check_trigger
        uses: actions/github-script@v7
        with:
          script: |
            // The following objects (github, context, core) are provided by the action environment
            const issueBody = context.payload.issue.body;
            const issueTitle = context.payload.issue.title;
            const issueNumber = context.payload.issue.number;

            // 1. Check if the issue title starts with 'DECRYPT'
            if (!issueTitle.startsWith('DECRYPT')) {
              console.log('Issue title does not start with "DECRYPT". Exiting workflow.');
              return; // Stop the workflow
            }

            // 2. Extract the PGP block from the issue body
            const startTag = '-----BEGIN PGP MESSAGE-----';
            const endTag = '-----END PGP MESSAGE-----';
            
            const startIndex = issueBody.indexOf(startTag);
            const endIndex = issueBody.indexOf(endTag) + endTag.length;
            
            if (startIndex === -1 || endIndex === -1) {
                // If the block is missing, comment and stop.
                await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: 'Decryption Failed: Could not find the complete PGP block (-----BEGIN/END PGP MESSAGE-----) in the issue description.'
                });
                console.log('Could not find PGP block. Exiting.');
                return;
            }
            
            // Extract the full PGP block
            const encryptedMessage = issueBody.substring(startIndex, endIndex);
            
            // 3. Set output variables for the next bash steps
            core.setOutput('encrypted_message', encryptedMessage);
            core.setOutput('issue_number', issueNumber);
            core.setOutput('should_proceed', 'true');

      - name: Exit if Trigger Not Found or PGP Block Missing
        if: ${{ steps.check_trigger.outputs.should_proceed != 'true' }}
        run: echo "Skipping subsequent steps."
        shell: bash

      ## 1. Import Private GPG Key (Uses Base64-encoded secret)
      - name: Import GPG Private Key
        if: ${{ steps.check_trigger.outputs.should_proceed == 'true' }}
        run: |
          echo "--- Starting GPG Key Import ---"
          # Decode the key and write it to a temporary file
          echo "${{ env.GPG_PRIVATE_KEY_SECRET }}" | base64 --decode > private.key
          
          # Import the key non-interactively
          gpg --batch --import --import-options expert private.key
          
          # Clean up the key file immediately
          rm private.key
        shell: bash

      ## 2. Decrypt the Message
      - name: Decrypt PGP Message
        id: decrypt_step
        if: ${{ steps.check_trigger.outputs.should_proceed == 'true' }}
        run: |
          ENCRYPTED_MESSAGE="${{ steps.check_trigger.outputs.encrypted_message }}"
          
          # Write the PGP message to a temporary file
          echo "$ENCRYPTED_MESSAGE" > encrypted_message.txt
          
          echo "--- Attempting Decryption ---"
          
          # GPG Decryption Command:
          # Capture output/logs using DECRYPT_OUTPUT variable
          DECRYPT_OUTPUT=$(gpg --batch --yes \
              --pinentry-mode loopback \
              --passphrase "${{ env.GPG_PASSPHRASE_SECRET }}" \
              -d encrypted_message.txt 2>&1)
              
          # Set outputs based on GPG exit code ($?)
          if [ $? -eq 0 ]; then
            echo "status=SUCCESS" >> $GITHUB_OUTPUT
            # Safely escape the output for the YAML context
            echo "output<<EOF" >> $GITHUB_OUTPUT
            echo "$DECRYPT_OUTPUT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "status=FAILED" >> $GITHUB_OUTPUT
            echo "output<<EOF" >> $GITHUB_OUTPUT
            echo "$DECRYPT_OUTPUT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
          
          # Clean up the temporary file
          rm encrypted_message.txt
        shell: bash

      ## 3. Post Comment and Close Issue
      - name: Post Result and Close Issue
        if: ${{ steps.check_trigger.outputs.should_proceed == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const status = `${{ steps.decrypt_step.outputs.status }}`;
            const output = `${{ steps.decrypt_step.outputs.output }}`;
            const issueNumber = ${{ steps.check_trigger.outputs.issue_number }};
            const repo = context.repo;

            let commentBody = '';
            let issueState = 'open';

            if (status === 'SUCCESS') {
                issueState = 'closed';
                commentBody = `✅ **Decryption Successful!**\n\nThe secured message has been retrieved:\n\n\`\`\`\n${output}\n\`\`\`\n\nThis issue has been closed as the decryption process is complete.`;
            } else {
                commentBody = `❌ **Decryption Failed!**\n\nThe GPG tool reported an error. This is usually due to an incorrect key, passphrase, or message format.\n\n**Error/Logs:**\n\`\`\`\n${output}\n\`\`\``;
            }

            // Post the comment
            await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: issueNumber,
                body: commentBody
            });

            // Close the issue if successful
            if (issueState === 'closed') {
                await github.rest.issues.update({
                    owner: repo.owner,
                    repo: repo.repo,
                    issue_number: issueNumber,
                    state: issueState
                });
            }
