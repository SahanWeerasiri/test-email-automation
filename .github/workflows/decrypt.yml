name: Issue-Based PGP Decryption

on:
  issues:
    types: [opened]

jobs:
  decrypt:
    # Only run if the issue title starts with "DECRYPT"
    if: startsWith(github.event.issue.title, 'DECRYPT')

    runs-on: ubuntu-latest
    
    # Restrict permissions for security
    permissions:
      contents: read
      issues: write # Allows the action to comment the result back into the issue

    steps:
      - name: üîç Extract Encrypted Content from Issue Body
        id: parse_issue
        run: |
          # 1. Look for the PGP block pattern in the issue body.
          # This command uses grep to find the block starting with 
          # -----BEGIN PGP MESSAGE----- and ending with -----END PGP MESSAGE-----
          ENCRYPTED_DATA=$(echo "${{ github.event.issue.body }}" | awk '/-----BEGIN PGP MESSAGE-----/,/-----END PGP MESSAGE-----/')
          
          # Check if content was found
          if [ -z "$ENCRYPTED_DATA" ]; then
            echo "::error::Could not find PGP MESSAGE block in the issue body."
            echo "ENCRYPTED_CONTENT_FOUND=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Set the found data as a step output
          echo "ENCRYPTED_CONTENT_FOUND=true" >> $GITHUB_OUTPUT
          
          # Pass the data for the next step (using a file is safer for large blocks)
          echo "$ENCRYPTED_DATA" > encrypted.pgp
        
      - name: üîê Setup GnuPG and Import Private Key
        # Only run if the content extraction was successful
        if: success() && steps.parse_issue.outputs.ENCRYPTED_CONTENT_FOUND == 'true'
        run: |
          # 1. Create a temporary, isolated GPG home directory
          export GNUPGHOME=$(mktemp -d)
          echo "GPG Home set to: $GNUPGHOME"

          # 2. Import the Private Key from Secret
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          
          # 3. Trust the key for non-interactive use (Optional but often needed)
          KEY_FINGERPRINT=$(gpg --list-secret-keys --with-colons | grep "^fpr" | awk -F: '{print $10}' | head -n 1)
          if [ -n "$KEY_FINGERPRINT" ]; then
            echo -e "5\ny\n" | gpg --command-fd 0 --edit-key "$KEY_FINGERPRINT" trust
            echo "Key trusted."
          else
            echo "Warning: Could not find key fingerprint."
          fi
          
          echo "GNUPGHOME=$GNUPGHOME" >> $GITHUB_ENV # Store GPG home for cleanup
          
      - name: üîë Decrypt Content
        id: decrypt_step
        if: success()
        env:
          PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }} # Securely retrieve passphrase
          
        run: |
          # Use the passphrase environment variable to automatically enter the key phrase
          DECRYPT_STATUS="failed"
          DECRYPTED_RESULT=$(gpg --batch --passphrase-fd 0 --output - --decrypt encrypted.pgp 2>&1 <<< "$PASSPHRASE")

          # Check if decryption was successful (no GPG error in output)
          if echo "$DECRYPTED_RESULT" | grep -q "gpg: decryption failed:"; then
            echo "Decryption failed. Output: $DECRYPTED_RESULT"
            echo "DECRYPTED_CONTENT=Decryption failed. Check logs for details." >> $GITHUB_OUTPUT
          else
            echo "Decryption succeeded."
            # Set the decrypted content as an output variable
            echo "DECRYPTED_CONTENT<<EOF" >> $GITHUB_OUTPUT
            echo "$DECRYPTED_RESULT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            DECRYPT_STATUS="success"
          fi
          
          echo "DECRYPT_STATUS=$DECRYPT_STATUS" >> $GITHUB_OUTPUT
          
      - name: üí¨ Comment Decryption Result on Issue
        uses: peter-evans/create-or-update-comment@v3
        if: always() # Run even if decryption failed to report the error
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## üîì PGP Decryption Status: ${{ steps.decrypt_step.outputs.DECRYPT_STATUS }}
            
            ${{ steps.decrypt_step.outputs.DECRYPT_STATUS == 'success' && '### Decrypted Content' || ''}}
            
            ```plaintext
            ${{ steps.decrypt_step.outputs.DECRYPTED_CONTENT }}
            ```
            
            ---
            *Note: This message was automatically generated by the Decryption GitHub Action.*
            
      - name: üóëÔ∏è Cleanup
        # Crucial step: Remove the temporary GPG home directory immediately
        if: always()
        run: rm -rf "$GNUPGHOME"
        env:
          GNUPGHOME: ${{ env.GNUPGHOME }}
