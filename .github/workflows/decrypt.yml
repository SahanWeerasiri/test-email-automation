name: Issue-Based PGP Decryption

on:
  issues:
    types: [opened]

jobs:
  decrypt:
    # --- 1. Condition: Only run if the issue title starts with "DECRYPT" ---
    if: startsWith(github.event.issue.title, 'DECRYPT')

    runs-on: ubuntu-latest
    
    # --- 2. Permissions: Needed to read secrets, issue body, and write comments/close issue ---
    permissions:
      contents: read
      issues: write 

    steps:
      - name: üîç Extract Encrypted Content from Issue Body
        id: parse_issue
        run: |
          # Use awk to find the PGP block pattern in the issue body
          ENCRYPTED_DATA=$(echo "${{ github.event.issue.body }}" | awk '/-----BEGIN PGP MESSAGE-----/,/-----END PGP MESSAGE-----/')
          
          if [ -z "$ENCRYPTED_DATA" ]; then
            echo "::error::Could not find PGP MESSAGE block in the issue body."
            echo "ENCRYPTED_CONTENT_FOUND=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "ENCRYPTED_CONTENT_FOUND=true" >> $GITHUB_OUTPUT
          # Save the data to a temporary file for the gpg command
          echo "$ENCRYPTED_DATA" > encrypted.pgp
        
      - name: üîê Setup GnuPG and Import Private Key
        # Only proceed if the PGP block was successfully found
        if: success() && steps.parse_issue.outputs.ENCRYPTED_CONTENT_FOUND == 'true'
        run: |
          # Create a temporary, isolated GPG home directory
          export GNUPGHOME=$(mktemp -d)
          echo "GPG Home set to: $GNUPGHOME"

          # Import the Private Key from GitHub Secrets
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          
          # Optional: Trust the key for non-interactive use
          KEY_FINGERPRINT=$(gpg --list-secret-keys --with-colons | grep "^fpr" | awk -F: '{print $10}' | head -n 1)
          if [ -n "$KEY_FINGERPRINT" ]; then
            echo -e "5\ny\n" | gpg --command-fd 0 --edit-key "$KEY_FINGERPRINT" trust
          fi
          
          echo "GNUPGHOME=$GNUPGHOME" >> $GITHUB_ENV # Store GPG home for cleanup
          
      - name: üîë Decrypt Content
        id: decrypt_step
        if: success()
        env:
          PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }} # Securely retrieve passphrase
          
        run: |
          # Use the passphrase environment variable via standard input (fd 0)
          DECRYPTED_RESULT=$(gpg --batch --passphrase-fd 0 --output - --decrypt encrypted.pgp 2>&1 <<< "$PASSPHRASE")

          # Check for decryption failure message in the output
          if echo "$DECRYPTED_RESULT" | grep -q "gpg: decryption failed:"; then
            echo "DECRYPTED_CONTENT=Decryption failed. Check action logs for GPG errors." >> $GITHUB_OUTPUT
            echo "DECRYPT_STATUS=failed" >> $GITHUB_OUTPUT
          else
            echo "Decryption succeeded."
            # Use multi-line output variable syntax
            echo "DECRYPTED_CONTENT<<EOF" >> $GITHUB_OUTPUT
            echo "$DECRYPTED_RESULT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "DECRYPT_STATUS=success" >> $GITHUB_OUTPUT
          fi
          
      - name: üí¨ Comment Decryption Result and Close Issue
        uses: peter-evans/create-or-update-comment@v3
        if: always() # Run even if decryption failed to report the status
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## üîì PGP Decryption Status: ${{ steps.decrypt_step.outputs.DECRYPT_STATUS }}
            
            ${{ steps.decrypt_step.outputs.DECRYPT_STATUS == 'success' && '### Decrypted Content' || ''}}
            
            ```plaintext
            ${{ steps.decrypt_step.outputs.DECRYPTED_CONTENT }}
            ```
            
            ---
            *Note: This message was automatically generated by the Decryption GitHub Action.*
          
          # Close the issue ONLY if decryption was successful
          issue-state: ${{ steps.decrypt_step.outputs.DECRYPT_STATUS == 'success' && 'closed' || 'open' }}
            
      - name: üóëÔ∏è Cleanup
        # Remove the temporary GPG home directory immediately, even if previous steps failed
        if: always()
        run: rm -rf "${{ env.GNUPGHOME }}"
        env:
          GNUPGHOME: ${{ env.GNUPGHOME }}
